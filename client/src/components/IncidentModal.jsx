import React, { useState } from 'react';
import axios from 'axios';
import styles from './IncidentModal.module.css';
import HazardIcon from './icons/HazardIcon';
import {
  capitalizeWords,
  formatTime,
  incidentCategoryToDescMap,
  incidentCategoryToNameMap,
  truncateText,
} from '../utils/helpers';

const IncidentModal = ({ incident, onClose }) => {
  const [updating, setUpdating] = useState(false);

  if (!incident) return null;

  const handleStatusChange = async (newStatus) => {
    setUpdating(true);
    try {
      const response = await axios.put(
        `https://ellipsis-1.onrender.com/api/incidents/incident-history/${incident.incident_id}/${newStatus}`
      );
      const updatedIncidentFromServer = response.data;
      console.log('Incident updated:', updatedIncidentFromServer);
      alert(`Incident status updated to: ${newStatus}`);
    } catch (error) {
      console.error('Error updating status:', error);
      alert('Error updating status. Please try again.');
    } finally {
      setUpdating(false);
      onClose();
    }
  };

  return (
    <div className={styles.modalOverlay}>
      <div className={styles.modal}>
        <HazardIcon
          color={incident.severity === 'Critical' ? '#D21616' : '#F9D75C'}
          className={styles.icon}
        />
        <h2>
          {capitalizeWords(
            incidentCategoryToNameMap[incident.category] + ' alert!'
          )}
        </h2>
        <p className={styles.desc}>
          {incidentCategoryToDescMap[incident.category]}
        </p>
        <div className={styles.details}>
          <div className={styles.info}>
            <svg
              xmlns='http://www.w3.org/2000/svg'
              width='30'
              height='32'
              viewBox='0 0 30 32'
              fill='none'
            >
              <path
                fillRule='evenodd'
                clipRule='evenodd'
                d='M20.4464 18.0033C25.4466 18.0033 29.5 13.9731 29.5 9.00163C29.5 4.03017 25.4466 0 20.4464 0C15.4463 0 11.3929 4.03017 11.3929 9.00163C11.3929 10.763 11.9017 12.4063 12.7812 13.794L0.5 26.0047L6.5299 32L9.37518 29.1711L6.19053 26.0047L9.38099 22.8325L12.5656 25.9989L15.4109 23.17L12.2262 20.0036L15.6265 16.6229C17.0222 17.4974 18.6749 18.0033 20.4464 18.0033ZM20.4464 14.0025C23.2243 14.0025 25.4762 11.7636 25.4762 9.00163C25.4762 6.23971 23.2243 4.00073 20.4464 4.00073C17.6686 4.00073 15.4167 6.23971 15.4167 9.00163C15.4167 11.7636 17.6686 14.0025 20.4464 14.0025Z'
                fill='#1F1F1F'
              />
            </svg>
            <p className={styles.meta}>Session ID</p>
            <p>{incident.session_id}</p>
          </div>
          <div className={styles.info}>
            <svg
              xmlns='http://www.w3.org/2000/svg'
              width='32'
              height='32'
              viewBox='0 0 32 32'
              fill='none'
            >
              <path
                d='M32 16C32 24.8365 24.8365 32 16 32C7.16345 32 0 24.8365 0 16C0 7.16345 7.16345 0 16 0C24.8365 0 32 7.16345 32 16ZM2.91903 16C2.91903 23.2244 8.77558 29.081 16 29.081C23.2244 29.081 29.081 23.2244 29.081 16C29.081 8.77558 23.2244 2.91903 16 2.91903C8.77558 2.91903 2.91903 8.77558 2.91903 16Z'
                fill='#1F1F1F'
              />
              <path
                d='M16 5.81818C15.1967 5.81818 14.5455 6.4694 14.5455 7.27273V16.6788C14.5455 16.6788 14.5455 17.058 14.7297 17.3433C14.8531 17.5852 15.0454 17.7953 15.298 17.9412L22.0177 21.8209C22.7135 22.2225 23.6031 21.9841 24.0047 21.2884C24.4063 20.5927 24.168 19.7031 23.4723 19.3015L17.4545 15.8272V7.27273C17.4545 6.46941 16.8033 5.81818 16 5.81818Z'
                fill='#1F1F1F'
              />
            </svg>
            <p className={styles.meta}>Time</p>
            <p>{formatTime(incident.incident_time)}</p>
          </div>
          <div className={styles.info}>
            <svg
              xmlns='http://www.w3.org/2000/svg'
              width='40'
              height='32'
              viewBox='0 0 40 32'
              fill='none'
            >
              <path
                d='M34.4572 7.11111H30.8429V3.55556H34.4572C34.9365 3.55556 35.3961 3.36825 35.735 3.03486C36.0739 2.70146 36.2643 2.24927 36.2643 1.77778C36.2643 1.30628 36.0739 0.854097 35.735 0.520699C35.3961 0.187301 34.9365 0 34.4572 0H23.6142C23.1349 0 22.6753 0.187301 22.3363 0.520699C21.9974 0.854097 21.807 1.30628 21.807 1.77778C21.807 2.24927 21.9974 2.70146 22.3363 3.03486C22.6753 3.36825 23.1349 3.55556 23.6142 3.55556H27.2285V7.11111H12.7712V3.55556H16.3856C16.8648 3.55556 17.3245 3.36825 17.6634 3.03486C18.0023 2.70146 18.1927 2.24927 18.1927 1.77778C18.1927 1.30628 18.0023 0.854097 17.6634 0.520699C17.3245 0.187301 16.8648 0 16.3856 0H5.54258C5.06329 0 4.60363 0.187301 4.26472 0.520699C3.92582 0.854097 3.73542 1.30628 3.73542 1.77778C3.73542 2.24927 3.92582 2.70146 4.26472 3.03486C4.60363 3.36825 5.06329 3.55556 5.54258 3.55556H9.15691V7.11111H5.54258C4.10471 7.11111 2.72574 7.67301 1.70901 8.67321C0.692285 9.6734 0.121094 11.03 0.121094 12.4444C0.121094 13.8589 0.692285 15.2155 1.70901 16.2157C2.72574 17.2159 4.10471 17.7778 5.54258 17.7778H9.33762C9.62719 19.139 10.2403 20.4135 11.1267 21.4969C9.0534 21.8744 7.17956 22.9533 5.82971 24.5468C4.47987 26.1403 3.739 28.148 3.73542 30.2222C3.73542 30.6937 3.92582 31.1459 4.26472 31.4793C4.60363 31.8127 5.06329 32 5.54258 32C6.02187 32 6.48153 31.8127 6.82044 31.4793C7.15935 31.1459 7.34974 30.6937 7.34974 30.2222C7.34974 28.8077 7.92093 27.4512 8.93766 26.451C9.95439 25.4508 11.3334 24.8889 12.7712 24.8889H18.1927V28.4444C18.1927 28.9159 18.3831 29.3681 18.722 29.7015C19.0609 30.0349 19.5206 30.2222 19.9999 30.2222C20.4792 30.2222 20.9388 30.0349 21.2777 29.7015C21.6166 29.3681 21.807 28.9159 21.807 28.4444V24.8889H27.2285C28.6664 24.8889 30.0454 25.4508 31.0621 26.451C32.0788 27.4512 32.65 28.8077 32.65 30.2222C32.65 30.6937 32.8404 31.1459 33.1793 31.4793C33.5182 31.8127 33.9779 32 34.4572 32C34.9365 32 35.3961 31.8127 35.735 31.4793C36.0739 31.1459 36.2643 30.6937 36.2643 30.2222C36.2607 28.1477 35.5196 26.1398 34.1694 24.5463C32.8191 22.9528 30.9449 21.874 28.8712 21.4969C29.7583 20.4137 30.372 19.1392 30.6621 17.7778H34.4572C35.8951 17.7778 37.274 17.2159 38.2908 16.2157C39.3075 15.2155 39.8787 13.8589 39.8787 12.4444C39.8787 11.03 39.3075 9.6734 38.2908 8.67321C37.274 7.67301 35.8951 7.11111 34.4572 7.11111ZM34.4572 14.2222H29.0357C28.5564 14.2222 28.0967 14.4095 27.7578 14.7429C27.4189 15.0763 27.2285 15.5285 27.2285 16C27.2285 17.4145 26.6573 18.771 25.6406 19.7712C24.6239 20.7714 23.2449 21.3333 21.807 21.3333H18.1927C16.7549 21.3333 15.3759 20.7714 14.3591 19.7712C13.3424 18.771 12.7712 17.4145 12.7712 16C12.7712 15.5285 12.5808 15.0763 12.2419 14.7429C11.903 14.4095 11.4434 14.2222 10.9641 14.2222H5.54258C5.06329 14.2222 4.60363 14.0349 4.26472 13.7015C3.92582 13.3681 3.73542 12.9159 3.73542 12.4444C3.73542 11.9729 3.92582 11.5208 4.26472 11.1874C4.60363 10.854 5.06329 10.6667 5.54258 10.6667H34.4572C34.9365 10.6667 35.3961 10.854 35.735 11.1874C36.0739 11.5208 36.2643 11.9729 36.2643 12.4444C36.2643 12.9159 36.0739 13.3681 35.735 13.7015C35.3961 14.0349 34.9365 14.2222 34.4572 14.2222ZM23.6142 16C23.6142 16.943 23.2334 17.8474 22.5556 18.5142C21.8778 19.181 20.9585 19.5556 19.9999 19.5556C19.0413 19.5556 18.122 19.181 17.4442 18.5142C16.7664 17.8474 16.3856 16.943 16.3856 16C16.3916 15.6486 16.4526 15.3003 16.5663 14.9671C16.6848 15.2316 16.8671 15.4638 17.0974 15.6433C17.3277 15.8229 17.5991 15.9445 17.888 15.9976C18.1768 16.0507 18.4745 16.0337 18.7552 15.9481C19.0359 15.8624 19.2911 15.7108 19.4987 15.5062C19.7064 15.3016 19.8602 15.0503 19.9468 14.7741C20.0334 14.4978 20.0502 14.2049 19.9958 13.9209C19.9414 13.6368 19.8174 13.37 19.6345 13.1437C19.4516 12.9174 19.2154 12.7384 18.9463 12.6222C19.2865 12.5113 19.6416 12.4514 19.9999 12.4444C20.9585 12.4444 21.8778 12.819 22.5556 13.4858C23.2334 14.1526 23.6142 15.057 23.6142 16Z'
                fill='#1F1F1F'
              />
            </svg>
            <p className={styles.meta}>Device</p>
            <p>
              {incident.camera_name
                ? truncateText(incident.camera_name, 16)
                : 'N/A'}
            </p>
          </div>
        </div>
        <div className={styles.buttons}>
          <button className={styles.acknowledgeButton} onClick={onClose}>
            Acknowledge
          </button>
          <button
            onClick={() => handleStatusChange('Resolved')}
            disabled={updating}
          >
            Resolved
          </button>
          <button
            onClick={() => handleStatusChange('False Alarm')}
            disabled={updating}
          >
            Mark as False
          </button>
        </div>
      </div>
    </div>
  );
};

export default IncidentModal;
